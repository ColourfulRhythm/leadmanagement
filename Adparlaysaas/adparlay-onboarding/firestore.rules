rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Forms collection - users can read/write their own forms, public can read published forms
    match /forms/{formId} {
      allow read: if resource.data.is_published == true || request.auth != null;
      allow write: if request.auth != null && request.auth.uid == resource.data.user_id;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.user_id;
    }
    
    // Form responses - anyone can create (for lead collection), users can read their own form responses
    match /form_responses/{responseId} {
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/forms/$(resource.data.form_id)) &&
        get(/databases/$(database)/documents/forms/$(resource.data.form_id)).data.user_id == request.auth.uid;
      allow create: if true; // Anyone can submit responses for lead collection
    }
    
    // Analytics - anyone can create (for tracking), users can read analytics for their own forms
    match /analytics/{eventId} {
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/forms/$(resource.data.form_id)) &&
        get(/databases/$(database)/documents/forms/$(resource.data.form_id)).data.user_id == request.auth.uid;
      allow create: if true; // Anyone can create analytics events
    }
  }
}
